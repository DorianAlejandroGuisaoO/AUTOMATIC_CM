{% extends 'dashboard/base.html' %}

{% block title %}Responder Comentario - Reddit Manager{% endblock %}

{% block content %}
<div class="comment-detail-view">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'reddit_manager' %}">ğŸ“± Posts</a> / 
        <a href="{% url 'post_detail' comment.post.post_id %}">{{ comment.post.title|truncatewords:5 }}</a> /
        <span>ğŸ’¬ Comentario</span>
    </nav>

    <!-- Comment Card -->
    <div class="comment-display-card">
        <div class="card-header">
            <h3>ğŸ’¬ Comentario Original</h3>
            <span class="status-badge {{ comment.status_badge.class }}">
                {{ comment.status_badge.text }}
            </span>
        </div>
        <div class="comment-info">
            <span class="info-item">
                <strong>ğŸ‘¤ {{ comment.author }}</strong>
            </span>
            <span class="info-item">
                ğŸ“… {{ comment.created_at|date:"d/m/Y H:i" }}
            </span>
            <a href="{{ comment.permalink }}" target="_blank" class="info-item link">
                ğŸ”— Ver en Reddit
            </a>
        </div>
        <div class="comment-text">
            {{ comment.content }}
        </div>
    </div>

    <!-- Response Generation -->
    {% if not response or response.status == 'rejected' %}
    <div class="generation-section">
        <h3 class="section-title">âœ¨ Generar Respuesta con IA</h3>
        <p class="section-subtitle">Elige el tono de la respuesta que deseas generar:</p>
        
        <div class="tone-buttons">
            <button onclick="generateResponse('formal')" class="btn-tone" data-tone="formal">
                <span class="tone-icon">ğŸ‘”</span>
                <span class="tone-name">Formal</span>
                <span class="tone-desc">Profesional y educado</span>
            </button>
            <button onclick="generateResponse('friendly')" class="btn-tone" data-tone="friendly">
                <span class="tone-icon">ğŸ˜Š</span>
                <span class="tone-name">Amigable</span>
                <span class="tone-desc">Cercano y cÃ¡lido</span>
            </button>
            <button onclick="generateResponse('informative')" class="btn-tone" data-tone="informative">
                <span class="tone-icon">ğŸ’¡</span>
                <span class="tone-name">Informativo</span>
                <span class="tone-desc">Claro y preciso</span>
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Response Display -->
    {% if response and response.status != 'rejected' %}
    <div class="response-section">
        <div class="section-header">
            <h3 class="section-title">ğŸ¤– Respuesta Generada</h3>
            <span class="tone-badge">âœ¨ Tono: {{ response.get_tone_display }}</span>
        </div>

        <div class="response-card">
            <textarea 
                id="responseText" 
                class="response-textarea"
                {% if response.status == 'published' %}readonly{% endif %}
            >{{ response.final_text }}</textarea>
            
            <div class="response-actions">
                {% if response.status == 'pending' %}
                    <button onclick="updateResponse()" class="btn btn-secondary" id="updateBtn">
                        <span>âœï¸</span> Guardar EdiciÃ³n
                    </button>
                    <button onclick="regenerateResponse()" class="btn btn-outline">
                        <span>ğŸ”„</span> Regenerar
                    </button>
                    <button onclick="publishResponse()" class="btn btn-primary" id="publishBtn">
                        <span>âœ…</span> Publicar en Reddit
                    </button>
                    <button onclick="rejectResponse()" class="btn btn-danger">
                        <span>âŒ</span> Descartar
                    </button>
                {% elif response.status == 'published' %}
                    <div class="published-info">
                        <span class="success-icon">âœ…</span>
                        <span>Publicado el {{ response.published_at|date:"d/m/Y H:i" }}</span>
                        <a href="{{ comment.permalink }}" target="_blank" class="btn btn-outline btn-sm">
                            <span>ğŸ”—</span> Ver en Reddit
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if response.status == 'pending' %}
        <div class="help-text">
            ğŸ’¡ <strong>Tip:</strong> Puedes editar la respuesta antes de publicarla para personalizarla
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
const commentId = "{{ comment.comment_id }}";
{% if response %}
const responseId = {{ response.id }};
{% endif %}

function generateResponse(tone) {
    const buttons = document.querySelectorAll('.btn-tone');
    buttons.forEach(btn => btn.disabled = true);
    
    const activeBtn = document.querySelector(`[data-tone="${tone}"]`);
    const icons = {'formal': 'ğŸ‘”', 'friendly': 'ğŸ˜Š', 'informative': 'ğŸ’¡'};
    activeBtn.innerHTML = '<span class="spinner"></span> Generando...';

    fetch(`/dashboard/reddit/comment/${commentId}/generate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `tone=${tone}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ… Respuesta generada exitosamente', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('âŒ Error al generar respuesta', 'error');
            buttons.forEach(btn => btn.disabled = false);
            activeBtn.innerHTML = `
                <span class="tone-icon">${icons[tone]}</span>
                <span class="tone-name">${tone.charAt(0).toUpperCase() + tone.slice(1)}</span>
            `;
        }
    })
    .catch(error => {
        showMessage('âŒ Error de conexiÃ³n', 'error');
        console.error('Error:', error);
        buttons.forEach(btn => btn.disabled = false);
    });
}

function updateResponse() {
    const editedText = document.getElementById('responseText').value.trim();
    
    if (!editedText) {
        showMessage('âŒ El texto no puede estar vacÃ­o', 'error');
        return;
    }

    const btn = document.getElementById('updateBtn');
    const originalText = showLoading(btn);

    fetch(`/dashboard/reddit/response/${responseId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `edited_text=${encodeURIComponent(editedText)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ… Respuesta actualizada correctamente', 'success');
        } else {
            showMessage('âŒ Error al actualizar respuesta', 'error');
        }
        hideLoading(btn);
    })
    .catch(error => {
        showMessage('âŒ Error de conexiÃ³n', 'error');
        console.error('Error:', error);
        hideLoading(btn);
    });
}

function regenerateResponse() {
    if (!confirm('Â¿Deseas regenerar la respuesta? Se perderÃ¡n las ediciones actuales.')) {
        return;
    }
    location.reload();
}

function publishResponse() {
    if (!confirm('Â¿EstÃ¡s seguro de publicar esta respuesta en Reddit?')) {
        return;
    }

    const btn = document.getElementById('publishBtn');
    const originalText = showLoading(btn);

    fetch(`/dashboard/reddit/response/${responseId}/publish/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ… Â¡Respuesta publicada exitosamente en Reddit!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(`âŒ ${data.error || 'Error al publicar respuesta'}`, 'error');
            hideLoading(btn);
        }
    })
    .catch(error => {
        showMessage('âŒ Error de conexiÃ³n', 'error');
        console.error('Error:', error);
        hideLoading(btn);
    });
}

function rejectResponse() {
    if (!confirm('Â¿Deseas descartar esta respuesta?')) {
        return;
    }

    fetch(`/dashboard/reddit/response/${responseId}/reject/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ… Respuesta descartada', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('âŒ Error al descartar respuesta', 'error');
        }
    })
    .catch(error => {
        showMessage('âŒ Error de conexiÃ³n', 'error');
        console.error('Error:', error);
    });
}
</script>
{% endblock %}